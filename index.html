<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HM Trading Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- Error Toast for API failures -->
    <div id="error-toast" class="error-toast">
        <button class="error-toast-close" onclick="hideErrorToast()">&times;</button>
        <div class="error-toast-title">‚ö†Ô∏è <span id="error-toast-title">Error</span></div>
        <div class="error-toast-message" id="error-toast-message">An error occurred</div>
    </div>

    <!-- JS Error Panel - Shows caught JavaScript errors -->
    <div id="js-error-panel" class="js-error-panel" style="display: none;">
        <div class="js-error-header">
            <span>üêõ JavaScript Errors</span>
            <button onclick="document.getElementById('js-error-panel').style.display='none'; jsErrorLog.length=0;">&times;</button>
        </div>
        <div id="js-error-list" class="js-error-list"></div>
    </div>

    <!-- BitMEX-Style Header -->
    <div class="trading-header">
        <div class="instrument-dropdown" id="instrument-dropdown">
            <span class="instrument-name" id="header-instrument">BTCUSD</span>
            <span class="instrument-type">Perpetual</span>
            <span style="color: #8b949e;">‚ñº</span>
        </div>
        <div class="instrument-badges">
            <span class="badge-sm badge-btc">BTC</span>
            <span class="badge-sm badge-leverage">100X</span>
        </div>
        <div class="price-section">
            <div class="price-main" id="header-price">
                <span id="price-value">--</span>
                <span class="price-arrow" id="price-arrow">‚Üë</span>
            </div>
            <div class="price-change" id="header-change">-0.00%</div>
        </div>
        <div class="header-stats">
            <div class="header-stat">
                <span class="header-stat-label">Mark Price</span>
                <span class="header-stat-value" id="header-mark">--</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">24H Volume</span>
                <span class="header-stat-value" id="header-volume">--</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">Funding Rate</span>
                <span class="header-stat-value" id="header-funding">--</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">Next Funding</span>
                <span class="header-stat-value" id="header-next-funding">--</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">High Price</span>
                <span class="header-stat-value positive" id="header-high">--</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">Low Price</span>
                <span class="header-stat-value negative" id="header-low">--</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">Open Interest</span>
                <span class="header-stat-value" id="header-oi">--</span>
            </div>
        </div>
    </div>

    <!-- Main Trading Layout -->
    <div class="trading-main">
        <!-- Chart Section (Left ~70%) -->
        <div class="chart-section">
            <div class="chart-toolbar">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <select id="market-selector" class="period-btn" style="min-width: 180px;">
                        <!-- Populated from js/config/ui-options.js -->
                    </select>
                    <div class="period-dropdown">
                        <button class="period-btn" id="period-btn">
                            <span id="period-label">5m</span>
                            <span>‚ñº</span>
                        </button>
                        <div class="period-menu" id="period-menu">
                            <!-- Populated from js/config/ui-options.js -->
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="color: #8b949e; font-size: 11px;" id="candle-count">-- candles</span>
                    <span class="instrument-badge" id="live-indicator">‚óè LIVE</span>
                </div>
            </div>
            <!-- OHLC Display -->
            <div class="ohlc-display">
                <div class="ohlc-item">
                    <span class="ohlc-label">O</span>
                    <span class="ohlc-value" id="ohlc-open">--</span>
                </div>
                <div class="ohlc-item">
                    <span class="ohlc-label">H</span>
                    <span class="ohlc-value" id="ohlc-high">--</span>
                </div>
                <div class="ohlc-item">
                    <span class="ohlc-label">L</span>
                    <span class="ohlc-value" id="ohlc-low">--</span>
                </div>
                <div class="ohlc-item">
                    <span class="ohlc-label">C</span>
                    <span class="ohlc-value" id="ohlc-close">--</span>
                </div>
                <div class="ohlc-item" style="margin-left: 12px;">
                    <span class="ohlc-label">Vol</span>
                    <span class="ohlc-value" id="ohlc-volume">--</span>
                </div>
            </div>
            <div class="chart-container-pro">
                <div id="live-price-chart-container"></div>
            </div>
            <!-- Bottom Period Selector -->
            <div class="chart-period-bar">
                <!-- Populated from js/config/ui-options.js -->
            </div>
        </div>

        <!-- Right Panel (Orderbook + Trades) -->
        <div class="right-panel">
            <!-- Price to Beat panel - only shows for Polymarket A markets -->
            <div class="panel-section price-to-beat-section" id="price-to-beat-panel" style="display: none;">
                <div class="panel-header">
                    <span>üìä PRICE TO BEAT</span>
                    <span id="ptb-countdown">--:--</span>
                </div>
                <div class="panel-content" style="padding: 8px 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 10px; color: #888;">Reference BTC Price</div>
                            <div id="ptb-btc-price" style="font-size: 18px; font-weight: bold; color: #fff;">--</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 10px; color: #888;">Window</div>
                            <div id="ptb-window" style="font-size: 12px; color: #fff;">--:-- - --:--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orderbook - shrinks to fit, never scrolls -->
            <div class="panel-section orderbook-section">
                <div class="panel-header">
                    <span>ORDER BOOK</span>
                    <span id="orderbook-spread-header">SPREAD: --</span>
                </div>
                <div class="panel-content" id="orderbook-panel">
                    <div class="orderbook-row header">
                        <span class="ob-price">Price</span>
                        <span class="ob-size">Size</span>
                        <span class="ob-total">Total</span>
                    </div>
                    <div id="orderbook-asks-pro"></div>
                    <div class="spread-row" id="spread-row">Spread: -- (0.00%)</div>
                    <div id="orderbook-bids-pro"></div>
                </div>
            </div>

            <!-- Recent Trades - fills remaining space, has scrollbar -->
            <div class="panel-section trades-section">
                <div class="panel-header">
                    <span>RECENT TRADES</span>
                    <span id="trades-count">0</span>
                </div>
                <div class="panel-content" id="trades-panel">
                    <div class="trade-row header">
                        <span class="trade-time">Time</span>
                        <span class="trade-side">Side</span>
                        <span class="trade-price">Price</span>
                        <span class="trade-size">Size</span>
                    </div>
                    <div id="recent-trades-pro"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Tab Bar -->
    <div class="tab-bar">
        <div class="tab-item active" data-tab="bots">Your Bots</div>
    </div>

    <!-- Tab Contents -->

    <!-- YOUR BOTS TAB -->
    <div id="tab-bots" class="tab-content active">
        <!-- Sub-tabs for Running Sessions / Scrapers / History -->
        <div class="session-sub-tabs">
            <div class="session-sub-tab active" data-panel="running">
                ü§ñ Running Sessions
                <span class="tab-count-badge" id="running-count">0</span>
            </div>
            <div class="session-sub-tab" data-panel="scrapers">
                üì° Scrapers
                <span class="tab-count-badge" id="scrapers-count">0</span>
            </div>
            <div class="session-sub-tab" data-panel="history">
                üìú History
                <span class="tab-count-badge" id="history-count">0</span>
            </div>
        </div>

        <!-- RUNNING SESSIONS PANEL -->
        <div id="panel-running" class="session-panel active">
            <div class="session-toolbar">
                <div class="session-filters">
                    <select class="session-filter-select" id="filter-market-running">
                        <!-- Populated from js/config/ui-options.js -->
                    </select>
                    <select class="session-filter-select" id="filter-strategy-running">
                        <option value="">All Strategies</option>
                    </select>
                </div>
                <button class="btn-new-session" id="btn-new-session">
                    + New Session
                </button>
            </div>

            <div class="session-list" id="running-sessions-list">
                <!-- Running sessions will be populated here -->
                <div class="session-empty" id="running-empty">
                    <div class="session-empty-icon">ü§ñ</div>
                    <div class="session-empty-text">No running sessions</div>
                    <button class="btn-new-session" onclick="openNewSessionModal()">+ Start a Session</button>
                </div>
            </div>
        </div>

        <!-- SCRAPERS PANEL -->
        <div id="panel-scrapers" class="session-panel">
            <div class="session-toolbar">
                <div class="session-filters">
                    <select class="session-filter-select" id="filter-market-scrapers">
                        <!-- Populated from js/config/ui-options.js -->
                    </select>
                </div>
                <button class="btn-new-session" onclick="openNewSessionModal('scraper')">
                    + New Scraper
                </button>
            </div>

            <div class="session-list" id="scrapers-list">
                <!-- Scrapers will be populated here -->
                <div class="session-empty" id="scrapers-empty">
                    <div class="session-empty-icon">üì°</div>
                    <div class="session-empty-text">No active scrapers</div>
                    <button class="btn-new-session" onclick="openNewSessionModal('scraper')">+ Start a Scraper</button>
                </div>
            </div>
        </div>

        <!-- HISTORY PANEL -->
        <div id="panel-history" class="session-panel">
            <div class="session-toolbar">
                <div class="session-filters">
                    <select class="session-filter-select" id="filter-type-history">
                        <!-- Populated from js/config/ui-options.js -->
                    </select>
                    <select class="session-filter-select" id="filter-market-history">
                        <!-- Populated from js/config/ui-options.js -->
                    </select>
                    <select class="session-filter-select" id="filter-status-history">
                        <!-- Populated from js/config/ui-options.js -->
                    </select>
                </div>
            </div>

            <div class="session-list" id="history-list">
                <!-- History will be populated here -->
                <div class="session-empty" id="history-empty">
                    <div class="session-empty-icon">üìú</div>
                    <div class="session-empty-text">No session history</div>
                </div>
            </div>
            <div class="history-pagination" id="history-pagination">
                <button class="pagination-btn" id="history-prev-btn" onclick="loadHistoryPage('prev')">&laquo; Previous</button>
                <span class="pagination-info" id="history-page-info">Page 1 of 1</span>
                <button class="pagination-btn" id="history-next-btn" onclick="loadHistoryPage('next')">Next &raquo;</button>
            </div>
        </div>

        <!-- INLINE SESSION DETAIL VIEW -->
        <div id="inline-session-detail" class="session-panel" style="display: none;">
            <div class="session-toolbar">
                <button class="btn-back-to-list" onclick="hideInlineDetail()">
                    ‚Üê Back to Sessions
                </button>
                <div class="inline-detail-actions">
                    <button class="btn-session-action btn-session-backtest" id="inline-backtest-btn" style="display: none;">Launch Backtest</button>
                    <button class="btn-session-action btn-session-restart" id="inline-restart-btn">Restart</button>
                    <button class="btn-session-action btn-session-stop" id="inline-stop-btn">Stop</button>
                </div>
            </div>
            <div class="inline-detail-content">
                <div class="inline-detail-header">
                    <h3 id="inline-session-name">Session Name</h3>
                    <span class="inline-session-status" id="inline-session-status">running</span>
                </div>
                <div class="inline-detail-meta">
                    <span id="inline-session-market">XBTUSD</span>
                    <span id="inline-session-strategy">TestBot</span>
                    <span id="inline-session-runtime">00:00:00</span>
                    <span id="inline-session-params" class="session-params" style="display: none;"></span>
                </div>

                <!-- Metrics Summary -->
                <div class="inline-metrics-grid">
                    <div class="inline-metric">
                        <span class="inline-metric-label">Trades</span>
                        <span class="inline-metric-value" id="inline-trades">0</span>
                    </div>
                    <div class="inline-metric">
                        <span class="inline-metric-label">P&L</span>
                        <span class="inline-metric-value" id="inline-pnl">$0.00</span>
                    </div>
                    <div class="inline-metric">
                        <span class="inline-metric-label">Win Rate</span>
                        <span class="inline-metric-value" id="inline-winrate">0%</span>
                    </div>
                    <div class="inline-metric">
                        <span class="inline-metric-label">Max DD</span>
                        <span class="inline-metric-value" id="inline-maxdd">$0</span>
                    </div>
                </div>

                <!-- Equity Chart (left) + Trades (right) -->
                <div class="inline-equity-trades-row">
                    <div class="inline-equity-section">
                        <h4>Equity Curve</h4>
                        <div id="inline-equity-chart" style="height: 180px; width: 100%;"></div>
                    </div>
                    <div class="inline-trades-section">
                        <h4>Recent Trades</h4>
                        <div class="inline-trades-list" id="inline-trades-list">
                            <div class="inline-empty">No trades yet</div>
                        </div>
                    </div>
                </div>

                <!-- Logs below (extends down, no inner scrollbar) -->
                <div class="inline-logs-section">
                    <h4>Session Logs</h4>
                    <div class="inline-logs-list" id="inline-logs-list">
                        <div class="inline-empty">No logs available</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legacy compatibility: keep old elements hidden -->
        <div style="display: none;">
            <div class="running-bot-stats" id="test-stats-pro">
                <div class="test-stat">
                    <span class="stat-label">Duration</span>
                    <span class="stat-value" id="test-duration-pro">00:00:00</span>
                </div>
                <div class="test-stat">
                    <span class="stat-label">Trades</span>
                    <span class="stat-value" id="test-trades-pro">0</span>
                </div>
                <div class="test-stat">
                    <span class="stat-label">P&L</span>
                    <span class="stat-value" id="test-pnl-pro">$0.00</span>
                </div>
            </div>
            <select id="strategy-selector-pro">
                <!-- Populated from js/config/ui-options.js -->
            </select>
            <button id="btn-start-test-pro"></button>
            <button id="btn-stop-backtest-pro"></button>
            <div id="metric-winrate">--</div>
            <div id="metric-pf">--</div>
            <div id="metric-pnl">--</div>
            <div id="metric-trades">--</div>
            <div id="metric-avgtrade">--</div>
            <div id="metric-dd">--</div>
            <div id="equity-curve-pro"></div>
            <div id="divergence-badge-pro"></div>
            <div id="test-log-count">0 trades</div>
            <div id="test-log-list"></div>
            <div id="backtest-log-count">0 trades</div>
            <div id="backtest-log-list"></div>
        </div>
    </div>

    <!-- CREATE NEW SESSION MODAL -->
    <div class="modal-overlay" id="new-session-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Session</h3>
                <button class="modal-close" onclick="closeNewSessionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Session Type</label>
                    <select class="form-select" id="new-session-type">
                        <!-- Populated from js/config/ui-options.js -->
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Market</label>
                        <select class="form-select" id="new-session-market">
                            <!-- Populated from js/config/ui-options.js -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Strategy</label>
                        <select class="form-select" id="new-session-strategy">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Session Name (optional)</label>
                    <input type="text" class="form-input" id="new-session-name" placeholder="Auto-generated if empty">
                </div>

                <!-- Backtest date range (shown only for backtest type) -->
                <div class="form-row" id="backtest-range-fields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="datetime-local" class="form-input" id="new-session-start">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="datetime-local" class="form-input" id="new-session-end">
                    </div>
                </div>

                <!-- Fee configuration (shown for test/backtest, hidden for scraper) -->
                <div class="form-row" id="fee-config-fields">
                    <div class="form-group">
                        <label class="form-label">Maker Fee (rebate)</label>
                        <div class="input-with-suffix">
                            <input type="number" class="form-input" id="new-session-maker-fee" value="-0.025" step="0.001">
                            <span class="input-suffix">%</span>
                        </div>
                        <small class="form-hint">Negative = rebate for adding liquidity</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Taker Fee</label>
                        <div class="input-with-suffix">
                            <input type="number" class="form-input" id="new-session-taker-fee" value="0.075" step="0.001">
                            <span class="input-suffix">%</span>
                        </div>
                        <small class="form-hint">Fee for taking liquidity</small>
                    </div>
                </div>

                <!-- Strategy params (dynamic based on strategy) -->
                <div id="strategy-params-container" class="strategy-params" style="display: none;">
                    <div class="strategy-params-title">Strategy Parameters</div>
                    <div id="strategy-params-fields">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-cancel" onclick="closeNewSessionModal()">Cancel</button>
                <button class="btn-modal btn-modal-create" id="btn-create-session" onclick="createSession()">Create Session</button>
            </div>
        </div>
    </div>

    <!-- SESSION DETAIL MODAL -->
    <div class="modal-overlay" id="session-detail-modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <div class="modal-header-info">
                    <h3 class="modal-title" id="detail-session-name">Session Details</h3>
                    <div class="detail-session-meta">
                        <span class="detail-badge" id="detail-session-type">test</span>
                        <span class="detail-badge" id="detail-session-market">XBTUSD</span>
                        <span class="detail-badge" id="detail-session-strategy">DivergeBot</span>
                        <span class="detail-status" id="detail-session-status">running</span>
                    </div>
                </div>
                <button class="modal-close" onclick="closeSessionDetailModal()">&times;</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="info" onclick="switchDetailTab('info')">Info</button>
                <button class="modal-tab" data-tab="metrics" onclick="switchDetailTab('metrics')">Metrics</button>
                <button class="modal-tab" data-tab="trades" onclick="switchDetailTab('trades')">Trades</button>
                <button class="modal-tab" data-tab="logs" onclick="switchDetailTab('logs')">Logs</button>
            </div>
            <div class="modal-body modal-body-tabs">
                <!-- INFO TAB -->
                <div class="detail-tab-content active" id="tab-info">
                    <div class="detail-grid">
                        <div class="detail-section">
                            <h4 class="detail-section-title">Session Information</h4>
                            <div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value" id="detail-id">-</span></div>
                            <div class="detail-row"><span class="detail-label">Name:</span><span class="detail-value" id="detail-name">-</span></div>
                            <div class="detail-row"><span class="detail-label">Type:</span><span class="detail-value" id="detail-type">-</span></div>
                            <div class="detail-row"><span class="detail-label">Market:</span><span class="detail-value" id="detail-market">-</span></div>
                            <div class="detail-row"><span class="detail-label">Strategy:</span><span class="detail-value" id="detail-strategy">-</span></div>
                            <div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value" id="detail-status">-</span></div>
                        </div>
                        <div class="detail-section">
                            <h4 class="detail-section-title">Timing</h4>
                            <div class="detail-row"><span class="detail-label">Created:</span><span class="detail-value" id="detail-created">-</span></div>
                            <div class="detail-row"><span class="detail-label">Started:</span><span class="detail-value" id="detail-started">-</span></div>
                            <div class="detail-row"><span class="detail-label">Completed:</span><span class="detail-value" id="detail-completed">-</span></div>
                            <div class="detail-row"><span class="detail-label">Duration:</span><span class="detail-value" id="detail-duration">-</span></div>
                        </div>
                        <div class="detail-section detail-section-wide">
                            <h4 class="detail-section-title">Strategy Parameters</h4>
                            <pre class="detail-params" id="detail-params">{}</pre>
                        </div>
                        <div class="detail-section detail-section-wide">
                            <h4 class="detail-section-title">Notes</h4>
                            <textarea class="detail-notes" id="detail-notes" placeholder="Add notes..."></textarea>
                            <button class="btn-save-notes" onclick="saveSessionNotes()">Save Notes</button>
                        </div>
                    </div>
                </div>
                <!-- METRICS TAB -->
                <div class="detail-tab-content" id="tab-metrics">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-card-label">Total P&L</div>
                            <div class="metric-card-value" id="metric-pnl">$0.00</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-card-label">Total Trades</div>
                            <div class="metric-card-value" id="metric-trades">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-card-label">Win Rate</div>
                            <div class="metric-card-value" id="metric-winrate">0%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-card-label">Avg Win</div>
                            <div class="metric-card-value" id="metric-avgwin">$0.00</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-card-label">Avg Loss</div>
                            <div class="metric-card-value" id="metric-avgloss">$0.00</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-card-label">Max Drawdown</div>
                            <div class="metric-card-value" id="metric-drawdown">$0.00</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-card-label">Profit Factor</div>
                            <div class="metric-card-value" id="metric-pf">0.00</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-card-label">Sharpe Ratio</div>
                            <div class="metric-card-value" id="metric-sharpe">0.00</div>
                        </div>
                    </div>
                    <div class="equity-chart-section">
                        <h4 class="detail-section-title">Equity Curve</h4>
                        <div id="detail-equity-chart" style="height: 250px;"></div>
                    </div>
                </div>
                <!-- TRADES TAB -->
                <div class="detail-tab-content" id="tab-trades">
                    <div class="trades-table-container">
                        <table class="trades-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Action</th>
                                    <th>Side</th>
                                    <th>Price</th>
                                    <th>Size</th>
                                    <th>P&L</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody id="detail-trades-body">
                                <tr><td colspan="7" class="no-data">No trades yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="trades-pagination" id="trades-pagination">
                        <button class="pagination-btn" onclick="loadTradesPage('prev')">&laquo; Prev</button>
                        <span class="pagination-info" id="trades-page-info">Page 1</span>
                        <button class="pagination-btn" onclick="loadTradesPage('next')">Next &raquo;</button>
                    </div>
                </div>
                <!-- LOGS TAB -->
                <div class="detail-tab-content" id="tab-logs">
                    <div class="logs-controls">
                        <select class="logs-filter" id="logs-level-filter" onchange="filterLogs()">
                            <option value="">All Levels</option>
                            <option value="INFO">INFO</option>
                            <option value="TRADE">TRADE</option>
                            <option value="WARN">WARN</option>
                            <option value="ERROR">ERROR</option>
                        </select>
                        <label class="logs-autoscroll">
                            <input type="checkbox" id="logs-autoscroll-check" checked> Auto-scroll
                        </label>
                        <button class="btn-logs-stream" id="btn-logs-stream" onclick="toggleLogStream()">‚ñ∂ Start Stream</button>
                    </div>
                    <div class="logs-container" id="detail-logs-container">
                        <div class="log-line log-info">Logs will appear here...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-cancel" onclick="closeSessionDetailModal()">Close</button>
                <button class="btn-modal btn-modal-action" onclick="viewSessionOnChart()">View on Chart</button>
                <button class="btn-modal btn-modal-clone" onclick="cloneCurrentSession()">Clone Session</button>
            </div>
        </div>
    </div>

    <!-- Hidden legacy controls for JS compatibility -->
    <div style="display: none;">
        <select id="session-selector">
            <!-- Populated from js/config/ui-options.js -->
        </select>
        <select id="bot-selector">
            <!-- Populated from js/config/ui-options.js -->
        </select>
        <select id="date-selector">
            <!-- Populated from js/config/ui-options.js -->
        </select>
        <select id="candle-period-selector">
            <!-- Populated from js/config/ui-options.js -->
        </select>
        <select id="market-period-selector">
            <!-- Populated from js/config/ui-options.js -->
        </select>
    </div>

    <div class="container" style="display: none;">

        <!-- Live Test Control Panel -->
        <div class="live-test-panel" id="live-test-panel">
            <div class="live-test-header">
                <span class="live-test-title">üî¥ Live Test Control</span>
                <span class="live-test-badge badge-info" title="Backend API that manages bot processes and data collection">API Connected</span>
            </div>
            <div class="live-test-controls">
                <select id="strategy-selector" class="live-test-select">
                    <!-- Populated from js/config/ui-options.js -->
                </select>
                <div id="strategy-description" class="strategy-description" title="Strategy description">
                    Live market data only. Select a strategy to view trade overlays and backtest results.
                </div>
                <button id="btn-start-test" class="btn-start disabled" disabled>
                    <span>‚ñ∂</span> Start Live Test
                </button>
                <button id="btn-stop-backtest" class="btn-stop" disabled>
                    <span>‚ñ†</span> Stop & Backtest
                </button>
                <div class="live-status">
                    <div id="status-indicator" class="status-indicator ready"></div>
                    <span id="status-text" class="status-text">Ready</span>
                </div>
            </div>
            <!-- Real-time stats (shown when test is running) -->
            <div id="live-stats" class="live-stats">
                <div class="live-stats-grid">
                    <div class="live-stat-item">
                        <div id="live-trades" class="live-stat-value">0</div>
                        <div class="live-stat-label">Trades</div>
                    </div>
                    <div class="live-stat-item">
                        <div id="live-pnl" class="live-stat-value">$0.00</div>
                        <div class="live-stat-label">Running P&L</div>
                    </div>
                    <div class="live-stat-item">
                        <div id="live-duration" class="live-stat-value">00:00</div>
                        <div class="live-stat-label">Duration</div>
                    </div>
                    <div class="live-stat-item">
                        <div id="live-strategy" class="live-stat-value">-</div>
                        <div class="live-stat-label">Strategy</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Trade Feed (Poll-based) -->
        <div id="live-trade-feed" class="live-trade-feed">
            <div class="live-trade-feed-header">
                <span class="live-trade-feed-title">
                    <span>üì°</span> Live Trade Feed
                </span>
                <div class="poll-status">
                    <div id="poll-dot" class="ws-dot"></div>
                    <span id="poll-status-text">Ready</span>
                </div>
            </div>
            <div id="live-trade-list" class="live-trade-list">
                <div class="no-trades-message">Waiting for trades...</div>
            </div>
        </div>

        <!-- Loading/Error State -->
        <div id="loading-state" class="card full-width" style="margin-bottom: 20px;">
            <div class="loading">Loading backtest data...</div>
        </div>

        <!-- Session Comparison View -->
        <div id="comparison-container" class="comparison-container">
            <div class="comparison-header">
                <span class="comparison-title">üìä Session Comparison: TEST vs BACKTEST</span>
            </div>

            <div class="comparison-grid">
                <!-- Test Session Column -->
                <div class="session-column test">
                    <div class="session-label">
                        <span class="badge badge-info">TEST</span>
                        <span class="session-name">Test Session</span>
                    </div>
                    <div id="test-metrics">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Backtest Session Column -->
                <div class="session-column backtest">
                    <div class="session-label">
                        <span class="badge badge-real">BACKTEST</span>
                        <span class="session-name">Backtest Session</span>
                    </div>
                    <div id="backtest-metrics">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div class="comparison-summary">
                <div class="summary-title">Comparison Summary</div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div id="matching-count" class="number positive">0</div>
                        <div class="label">Matching Metrics</div>
                    </div>
                    <div class="summary-item">
                        <div id="different-count" class="number negative">0</div>
                        <div class="label">Different Metrics</div>
                    </div>
                </div>
            </div>

            <!-- Side-by-Side Trade Logs Comparison -->
            <div class="trade-logs-comparison">
                <div class="trade-logs-header">
                    <div class="trade-logs-title">
                        üìã Trade Decision Logs
                        <span id="divergence-count" class="divergence-indicator" style="display: none;">0 divergences</span>
                    </div>
                    <div class="trade-logs-filters">
                        <button class="filter-btn active" data-filter="all">All Trades</button>
                        <button class="filter-btn" data-filter="divergent">Divergences Only</button>
                        <button class="filter-btn" data-filter="matching">Matching Only</button>
                    </div>
                </div>
                <div class="trade-logs-container">
                    <!-- Test Trades Column -->
                    <div class="trade-log-column test">
                        <div class="trade-log-header">
                            <span class="badge badge-info">TEST</span>
                            <span>Live Test Trades</span>
                            <span id="test-trades-count" class="count">0 trades</span>
                        </div>
                        <div id="test-trades-log" class="trade-log-list">
                            <div class="no-trades-msg">No trades available</div>
                        </div>
                    </div>
                    <!-- Backtest Trades Column -->
                    <div class="trade-log-column backtest">
                        <div class="trade-log-header">
                            <span class="badge badge-real">BACKTEST</span>
                            <span>Backtest Trades</span>
                            <span id="backtest-trades-count" class="count">0 trades</span>
                        </div>
                        <div id="backtest-trades-log" class="trade-log-list">
                            <div class="no-trades-msg">No trades available</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Market Data Section -->
        <div id="live-market-content" class="active" style="display: block;">
            <div class="market-controls">
                <div class="market-control-group">
                    <span class="market-control-label">Market:</span>
                    <select id="market-selector-secondary" class="market-select">
                        <!-- Populated from js/config/ui-options.js -->
                    </select>
                </div>
                <div class="market-control-group">
                    <span class="market-control-label">Period:</span>
                    <select id="market-period-selector" class="market-select">
                        <!-- Populated from js/config/ui-options.js -->
                    </select>
                </div>
                <button id="refresh-market-btn" class="refresh-btn">üîÑ Refresh</button>
                <div class="market-price-display">
                    <span id="current-market-price" class="current-price">--</span>
                    <span id="price-change-badge" class="price-change" title="Price change from first to last candle in loaded data">
                        <span class="change-label">Period:</span> <span id="price-change-value">--</span>
                    </span>
                </div>
            </div>

            <!-- Live Price Chart -->
            <div class="card full-width" style="margin-bottom: 20px;">
                <div class="card-header">
                    <span class="card-title" id="live-chart-title">BTC/USD Live Price</span>
                    <span class="badge badge-info">LIVE DATA</span>
                </div>
                <div id="live-price-chart-container"></div>
                <div class="chart-legend" id="price-chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #26a69a;"></div>
                        <span>Price Candles</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2962FF;"></div>
                        <span>Volume</span>
                    </div>
                </div>
                <!-- Trade overlay legend (shown in strategy mode) -->
                <div class="chart-legend" id="trade-overlay-legend" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2196F3;"></div>
                        <span>Long Entry</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF9800;"></div>
                        <span>Short Entry</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00c853;"></div>
                        <span>Profit Exit</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff5252;"></div>
                        <span>Loss Exit</span>
                    </div>
                </div>
            </div>

            <!-- Equity Curve Chart (shown in strategy mode) -->
            <div id="equity-curve-container" class="card full-width" style="display: none; margin-bottom: 20px;">
                <div class="card-header">
                    <span class="card-title" id="equity-chart-title">Equity Curve</span>
                    <span class="badge badge-success" id="equity-badge">STRATEGY</span>
                </div>
                <div id="equity-curve-chart-container" style="height: 200px;"></div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4caf50;"></div>
                        <span>Equity</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff5252;"></div>
                        <span>Drawdown</span>
                    </div>
                </div>
            </div>

            <!-- Orderbook and Trades Grid -->
            <div class="market-data-grid">
                <div class="card">
                    <div class="orderbook-container">
                        <div class="orderbook-header">
                            <span class="orderbook-title">üìä Order Book</span>
                            <span id="orderbook-spread" class="orderbook-spread">Spread: --</span>
                        </div>
                        <div class="orderbook-sides">
                            <div class="orderbook-side bids">
                                <div class="orderbook-side-header">
                                    <span>Price</span>
                                    <span>Amount</span>
                                </div>
                                <div id="orderbook-bids"></div>
                            </div>
                            <div class="orderbook-side asks">
                                <div class="orderbook-side-header">
                                    <span>Price</span>
                                    <span>Amount</span>
                                </div>
                                <div id="orderbook-asks"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="trades-container">
                        <div class="trades-header">
                            <span class="trades-title">üìà Recent Trades</span>
                            <span id="trades-count" style="color: #8892b0; font-size: 0.85rem;">0 trades</span>
                        </div>
                        <table class="trades-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Side</th>
                                    <th>Price</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="trades-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-content" style="display: none;">
            <!-- TradingView Chart Section -->
            <div class="card full-width" style="margin-bottom: 20px;">
                <div class="card-header">
                    <span class="card-title" id="chart-title">BTC/USD Price & Bot P&L</span>
                    <span class="badge badge-real">C++ BACKTEST DATA</span>
                </div>
                <div id="chart-container"></div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #26a69a;"></div>
                        <span>BTC/USD Candles</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2196F3; clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
                        <span>Long Entry</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF9800; clip-path: polygon(0% 0%, 100% 0%, 50% 100%);"></div>
                        <span>Short Entry</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00c853; border-radius: 50%;"></div>
                        <span>Exit (Profit)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff5252; border-radius: 50%;"></div>
                        <span>Exit (Loss)</span>
                    </div>
                </div>
            </div>

            <div class="grid">
                <!-- All 14 Performance Metrics -->
                <div class="card full-width">
                    <div class="card-header">
                        <span class="card-title">Performance Metrics</span>
                        <span class="badge badge-success" id="metrics-badge">14 Metrics</span>
                    </div>
                    <div class="stat-grid-4" id="metrics-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Equity Curve with Drawdown -->
                <div class="card full-width">
                    <div class="card-header">
                        <span class="card-title">Equity Curve & Drawdown</span>
                        <span class="badge badge-info" id="equity-badge">Live</span>
                    </div>
                    <div id="equity-chart-container"></div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #00d4ff;"></div>
                            <span>Equity (BTC)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff5252;"></div>
                            <span>Drawdown</span>
                        </div>
                    </div>
                </div>

                <!-- Bot Configuration -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title" id="bot-name-title">Bot Configuration</span>
                        <span class="badge badge-info" id="bot-badge">Config</span>
                    </div>
                    <div id="config-section">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Trading Bots Overview (Clickable) -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Trading Bots</span>
                        <span class="badge badge-info">Click to Switch</span>
                    </div>
                    <div class="bot-card active" data-bot="DivergeBot">
                        <div class="bot-header">
                            <div class="bot-icon diverge">üîÄ</div>
                            <div>
                                <strong>DivergeBot</strong>
                                <div class="bot-desc">Price ratio divergence trading</div>
                            </div>
                        </div>
                    </div>
                    <div class="bot-card" data-bot="SazBot">
                        <div class="bot-header">
                            <div class="bot-icon saz">üìà</div>
                            <div>
                                <strong>SazBot</strong>
                                <div class="bot-desc">Order book imbalance analysis</div>
                            </div>
                        </div>
                    </div>
                    <div class="bot-card" data-bot="SDBot">
                        <div class="bot-header">
                            <div class="bot-icon sd">üìâ</div>
                            <div>
                                <strong>SDBot</strong>
                                <div class="bot-desc">Standard deviation mean reversion</div>
                            </div>
                        </div>
                    </div>
                    <div class="bot-card" data-bot="PairTradeBot">
                        <div class="bot-header">
                            <div class="bot-icon pair">üìä</div>
                            <div>
                                <strong>PairTradeBot</strong>
                                <div class="bot-desc">Statistical arbitrage using Bollinger Bands</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Unit Tests Results -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Unit Tests</span>
                        <span class="badge badge-success">15/15 Passed</span>
                    </div>
                    <ul class="test-list">
                        <li class="test-item">
                            <span class="test-name"><span class="test-icon">‚úÖ</span> test_types</span>
                            <span class="test-status passed">4 tests passed</span>
                        </li>
                        <li class="test-item">
                            <span class="test-name"><span class="test-icon">‚úÖ</span> test_order_book</span>
                            <span class="test-status passed">3 tests passed</span>
                        </li>
                        <li class="test-item">
                            <span class="test-name"><span class="test-icon">‚úÖ</span> test_indicators</span>
                            <span class="test-status passed">4 tests passed</span>
                        </li>
                        <li class="test-item">
                            <span class="test-name"><span class="test-icon">‚úÖ</span> test_scheduler</span>
                            <span class="test-status passed">3 tests passed</span>
                        </li>
                        <li class="test-item">
                            <span class="test-name"><span class="test-icon">‚úÖ</span> test_bots</span>
                            <span class="test-status passed">9 tests passed</span>
                        </li>
                    </ul>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 100%; background: linear-gradient(90deg, #00c853, #00d4ff);"></div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">System Status</span>
                        <span class="badge badge-success">Healthy</span>
                    </div>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-label">Build Status</div>
                            <div class="stat-value passed">‚úÖ Passing</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">C++ Standard</div>
                            <div class="stat-value">C++20</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">CMake Version</div>
                            <div class="stat-value">3.20+</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Data Source</div>
                            <div class="stat-value">JSON</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Trades Table -->
                <div class="card full-width">
                    <div class="card-header">
                        <span class="card-title">Trade Activity</span>
                        <span class="badge badge-info" id="trades-badge">0 trades</span>
                    </div>
                    <div class="table-wrapper">
                        <table class="trade-table" id="trades-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Qty</th>
                                    <th>P&L</th>
                                    <th>Cumulative</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Integration Tests -->
                <div class="card full-width">
                    <div class="card-header">
                        <span class="card-title">Integration & Backtest Tests</span>
                        <span class="badge badge-success">C++ JSON Output</span>
                    </div>
                    <ul class="test-list">
                        <li class="test-item">
                            <span class="test-name"><span class="test-icon">‚úÖ</span> JSON Data Loader</span>
                            <span class="test-status passed" id="json-status">Loading...</span>
                        </li>
                        <li class="test-item">
                            <span class="test-name"><span class="test-icon">‚úÖ</span> TradingView Chart</span>
                            <span class="test-status passed">Lightweight Charts v4</span>
                        </li>
                        <li class="test-item">
                            <span class="test-name"><span class="test-icon">‚úÖ</span> Backtest Metrics</span>
                            <span class="test-status passed" id="metrics-status">Loading...</span>
                        </li>
                        <li class="test-item">
                            <span class="test-name"><span class="test-icon">‚úÖ</span> Equity Curve</span>
                            <span class="test-status passed" id="equity-status">Loading...</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <p class="timestamp" id="timestamp">Last updated: Loading...</p>
    </div>

    <!-- Footer -->
    <footer class="dashboard-footer">
        <div class="footer-content">
            <div class="footer-logo">üìä HM Trading Dashboard</div>
            <div class="footer-links">
                <span>High-frequency trading analytics</span>
            </div>
            <div class="footer-copyright">
                ¬© 2025 HM Trading Systems
            </div>
        </div>
    </footer>

    <script src="js/core.js"></script>
    <script src="js/config/ui-options.js"></script>
    <script src="js/components/session-card.js"></script>
    <script src="js/components/session-detail-modal.js"></script>
    <script src="js/session-management.js"></script>
    <script src="js/components/live-market-ui.js"></script>
    <script src="js/components/live-test-button-hook.js"></script>
    <script src="js/dashboard-live.js"></script>
</body>
</html>
